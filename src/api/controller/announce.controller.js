const Announce=require("../model/announce.model"),Townhall=require("../model/townhall.model"),moment=require("moment");async function createBroadcast(e,n,o){try{new Announce({slug:e.body.slug,creator:e.body.creator,cid:e.body.cid,title:e.body.announce.title,summary:e.body.announce.summary,attachment:e.body.announce.attachment,importance:e.body.announce.importance,timezone:e.body.announce.timezone,expire_at:e.body.announce.date}).save().then((e=>{n.json({announce:e})}))}catch(e){console.log("api/controller/announce.controller/createBroadcast"+e)}}async function getAnnouncementList(e,n,o){try{let o={};o.slug=e.body.slug,"closed"==e.body.index||"open"==e.body.index?Announce.find(o).populate("creator").sort("-created_at").exec().then((o=>{let t=[],c=[];o.map(((e,n)=>{var o=new Date(e.expire_at);let a=60*moment().utcOffset(e.timezone.offset).utcOffset()*1e3,r=o.getTime()-a,l=new Date,s=60*l.getTimezoneOffset()*1e3;r>=l.getTime()-s?c.push(e):t.push(e)})),"closed"==e.body.index?n.json({list:t}):n.json({list:c})})):("important"==e.body.index&&(o.importance=!0),Announce.find(o).populate("creator").sort("-created_at").exec().then((e=>{n.json({list:e})})))}catch(e){console.log("api/controller/announce.controller/getAnnouncementList"+e)}}async function getAnnounceDate(e,n,o){try{Announce.findById(e.body._id).populate("creator").exec().then((e=>{n.json({announce:e})}))}catch(e){console.log("api/controller/user.controller"+e)}}async function deleteAnnouncement(e,n,o){try{Announce.deleteOne({_id:e.body._id}).exec().then((()=>{n.json({})}))}catch(e){console.log("api/controller/announce.controller/"+e)}}async function sample(e,n,o){try{await user.save(),User.find({}).then((e=>{console.log(e)}));n.json({list:"okay"})}catch(e){console.log("api/controller/announce.controller/"+e)}}module.exports={createBroadcast:createBroadcast,getAnnouncementList:getAnnouncementList,getAnnounceDate:getAnnounceDate,deleteAnnouncement:deleteAnnouncement};