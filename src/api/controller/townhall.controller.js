const Townhall=require("../model/townhall.model"),Account=require("../model/account.model");async function getTownhallData(a,l,o){try{Townhall.findOne({"details.slug":a.body.slug}).exec().then((a=>{l.json({townhall:a})})).catch((a=>console.error(a)))}catch(a){console.log("api/controller/townhall.controller/getTownhallData"+a)}}async function joinTownhall(a,l,o){try{Townhall.findOneAndUpdate({_id:a.body._id},{$push:{villagers:a.body.villager}}).then((a=>{l.json({townhall:a})})).catch((a=>console.error(a)))}catch(a){console.log("api/controller/townhall.controller/joinTownhall"+a)}}async function createTownHall(a,l,o){try{let o=a.body.data;var e=[];e.push(a.body._addr);var t=a.body.data.master.replace(/[, ]+/g,"").trim();if(""!=t)t.split("\n").map((a=>{e.push(a)}));var n=a.body.data.warden.replace(/[, ]+/g,"").trim();if(""!=n)n.split("\n").map((a=>{e.push(a)}));for(var r=[],c=0;c<e.length;c++){let a=await Account.findOne({address:e[c]}).exec();a&&r.push(a._id)}let d=new Townhall({superwarden:a.body._addr,villagers:r,details:o,created_at:new Date,updated_at:new Date});await d.save().then((async a=>{l.json({data:a})}))}catch(a){console.log("api/controller/townhall.controller"+a)}}async function getProposalData(a,l,o){try{l.json({data:[]})}catch(a){console.log("api/controller/townhall.controller/getProposalData"+a)}}async function updateTownHall(a,l,o){try{let o=a.body.data;var e=[];e.push(a.body.superwarden);var t=a.body.data.master.replace(/[, ]+/g,"").trim();if(""!=t)t.split("\n").map((a=>{e.push(a)}));var n=a.body.data.warden.replace(/[, ]+/g,"").trim();if(""!=n)n.split("\n").map((a=>{e.push(a)}));for(var r=[],c=0;c<e.length;c++){let a=await Account.findOne({address:e[c]}).exec();a&&r.push(a._id)}Townhall.findOneAndUpdate({"details.slug":a.body.slug},{$pull:{villagers:r},details:o,updated_at:new Date}).then((a=>{l.json({data:a})}))}catch(a){console.log("api/controller/townhall.controller/updateTownHall"+a)}}async function getMyTownhall(a,l,o){try{Townhall.findOne({superwarden:a.body._addr}).then((a=>{l.json({data:a})}))}catch(a){console.log("api/controller/townhall.controller"+a)}}async function getTownhallList(a,l,o){try{let o={};a.body.search.name&&(o["details.name"]=new RegExp(a.body.search.name,"i")),a.body.search.type&&"all"!=a.body.search.type&&(o["details.categories"]=a.body.search.type),Townhall.find(o).populate({path:"villagers"}).then((a=>{l.json({data:a})}))}catch(a){console.log("api/controller/townhall.controller"+a)}}async function checkSlugName(a,l,o){try{Townhall.count({"details.slug":a.body.slug}).exec().then((a=>{l.json({count:a})}))}catch(a){console.log("api/controller/townhall.controller"+a)}}module.exports={createTownHall:createTownHall,getMyTownhall:getMyTownhall,getTownhallList:getTownhallList,getProposalData:getProposalData,updateTownHall:updateTownHall,getTownhallData:getTownhallData,joinTownhall:joinTownhall,checkSlugName:checkSlugName};